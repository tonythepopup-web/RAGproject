# HACCP RAG API

ë²•ë¥ /ë§¤ë‰´ì–¼ ì§ˆì˜ì‘ë‹µ API (4ë‹¨ê³„ êµ¬ì¡°)

---

## ğŸ“ í´ë” êµ¬ì¡°

```
03_api/
â”œâ”€â”€ main.py                    # FastAPI ì•± ì‹œì‘ì 
â”œâ”€â”€ routers/
â”‚   â””â”€â”€ sync_api.py           # 4ë‹¨ê³„ API ì—”ë“œí¬ì¸íŠ¸
â”œâ”€â”€ schemas/                   # ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ queries.py            # 1ë‹¨ê³„: ì§ˆë¬¸/ì¹´í…Œê³ ë¦¬
â”‚   â”œâ”€â”€ answers.py            # 2ë‹¨ê³„: ë‹µë³€ ìƒì„±
â”‚   â”œâ”€â”€ feedback.py           # 3ë‹¨ê³„: ì²­í¬ í‰ê°€
â”‚   â””â”€â”€ chunks.py             # 4ë‹¨ê³„: ì²­í¬ ìƒì„¸
â”œâ”€â”€ services/                  # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ query_service.py      # ì¹´í…Œê³ ë¦¬ ì¶”ì²œ
â”‚   â”œâ”€â”€ answer_service.py     # ë‹µë³€ ìƒì„± (ë™ê¸°)
â”‚   â”œâ”€â”€ feedback_service.py   # í”¼ë“œë°± + Triplet ë¡œê¹…
â”‚   â””â”€â”€ chunk_service.py      # ì²­í¬ ì¡°íšŒ
â”œâ”€â”€ adapters/
â”‚   â””â”€â”€ rag_adapter.py        # 02_rag ì—°ê²° (Boot Once)
â”œâ”€â”€ storage/                   # ë©”ëª¨ë¦¬ ê¸°ë°˜ ì €ì¥ì†Œ
â”‚   â”œâ”€â”€ query_store.py
â”‚   â”œâ”€â”€ answer_store.py
â”‚   â”œâ”€â”€ feedback_store.py
â”‚   â””â”€â”€ chunk_store.py
â”œâ”€â”€ test_api.py               # 4ë‹¨ê³„ ì „ì²´ í…ŒìŠ¤íŠ¸
â”œâ”€â”€ run_server.bat            # Windows ì„œë²„ ì‹¤í–‰
â””â”€â”€ run_server.sh             # Linux/Mac ì„œë²„ ì‹¤í–‰

ì—°ê³„ ë°ì´í„° (ìƒëŒ€ ê²½ë¡œ):
../00_data/input/indexes/     # ì¸ë±ìŠ¤ ë°ì´í„°
â”œâ”€â”€ law/
â”‚   â””â”€â”€ YYYY-MM-DD/           # ë²•ë¥  ì¸ë±ìŠ¤ (ë‚ ì§œë³„)
â”‚       â”œâ”€â”€ idx_ì‹í’ˆìœ„ìƒë²•/
â”‚       â””â”€â”€ ... (11ê°œ ì¹´í…Œê³ ë¦¬)
â””â”€â”€ manual/
    â””â”€â”€ YYYY-MM-DD/           # ë§¤ë‰´ì–¼ ì¸ë±ìŠ¤ (ë‚ ì§œë³„)
        â”œâ”€â”€ idx_1. íš¨ìœ¨ì ì¸.../
        â””â”€â”€ ... (17ê°œ ì¹´í…Œê³ ë¦¬)
```

---

## ğŸš€ ì„œë²„ ì‹¤í–‰

### ë°©ë²• 1: ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê¶Œì¥)

**Windows:**
```bash
cd 03_api
run_server.bat
```

**Linux/Mac:**
```bash
cd 03_api
chmod +x run_server.sh
./run_server.sh
```

### ë°©ë²• 2: ì§ì ‘ ì‹¤í–‰

```bash
# 1. ê°€ìƒí™˜ê²½ í™œì„±í™”
source ragenv/bin/activate  # Windows: ragenv\Scripts\activate

# 2. ì„œë²„ ì‹¤í–‰
cd 03_api
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**ì„œë²„ ì‹œì‘ ì‹œ ì¶œë ¥ ë©”ì‹œì§€:**
```
âœ… [RAGAdapter] ì´ˆê¸°í™” ì™„ë£Œ!
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### ì ‘ì† í™•ì¸

- **Swagger UI (í…ŒìŠ¤íŠ¸)**: http://localhost:8000/docs
- **ReDoc (ë¬¸ì„œ)**: http://localhost:8000/redoc
- **Health Check**: http://localhost:8000/health

---

## ğŸ“ API ì—”ë“œí¬ì¸íŠ¸ (4ë‹¨ê³„)

### 1ë‹¨ê³„: POST /queries - ì§ˆë¬¸ â†’ ì¹´í…Œê³ ë¦¬ ì¶”ì²œ

**ì„¤ëª…:** ì‚¬ìš©ì ì§ˆë¬¸ì„ ë°›ì•„ ê´€ë ¨ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ì²œ (ì „ì²´ 1ê°œ + ì¶”ì²œ ìµœëŒ€ 2ê°œ = ì´ 3ê°œ)

**ìš”ì²­:**
```json
{
  "question": "HACCP ì¸ì¦ ì ˆì°¨ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?",
  "scope": "all"  // "law", "manual", "all"
}
```

**ì‘ë‹µ:**
```json
{
  "query_id": "q_abc123",
  "scope": "all",
  "question": "HACCP ì¸ì¦ ì ˆì°¨ëŠ”...",
  "category_candidates": [
    {
      "category_id": "ALL_ì „ì²´",
      "label": "ì „ì²´",
      "score": 1.0
    },
    {
      "category_id": "LAW_ì‹í’ˆìœ„ìƒë²•",
      "label": "ì‹í’ˆìœ„ìƒë²•",
      "score": 0.85
    }
  ],
  "created_at": "2025-01-15T10:30:00Z"
}
```

---

### 2ë‹¨ê³„: POST /answers - ë‹µë³€ ìƒì„±

**ì„¤ëª…:** ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ ìƒì„± (ë™ê¸° - 5~10ì´ˆ ì†Œìš”)

**ìš”ì²­:**
```json
{
  "query_id": "q_abc123",
  "selected_categories": ["LAW_ì‹í’ˆìœ„ìƒë²•", "MANUAL_HACCPê´€ë¦¬"]
}
```

**ì‘ë‹µ:**
```json
{
  "query_id": "q_abc123",
  "answer_id": "a_def456",
  "status": "succeeded",
  "answer": {
    "text": "ì‹í’ˆìœ„ìƒë²• ì œ48ì¡°ì— ë”°ë¥´ë©´ HACCP ì¸ì¦ì€...",
    "disclaimer": "ë³¸ ë‹µë³€ì€ ë²•ë¥  ìë¬¸ì´ ì•„ë‹ˆë©°, ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤."
  },
  "citations": [
    {
      "chunk_id": "c_001",
      "doc_title": "ì‹í’ˆìœ„ìƒë²• ì œ48ì¡° (ìœ„ìƒê´€ë¦¬)",
      "score": 0.87
    },
    {
      "chunk_id": "c_002",
      "doc_title": "HACCP ê´€ë¦¬ ë§¤ë‰´ì–¼ - ì¸ì¦ ì ˆì°¨",
      "score": 0.82
    }
  ],
  "timings": {
    "retrieval_ms": 342,
    "generation_ms": 1589
  },
  "created_at": "2025-01-15T10:30:00Z",
  "completed_at": "2025-01-15T10:30:02Z"
}
```

---

### 3ë‹¨ê³„: POST /feedback/chunks - ì²­í¬ í‰ê°€ ì €ì¥

**ì„¤ëª…:** ì—¬ëŸ¬ ì²­í¬ì— ëŒ€í•œ í‰ê°€ë¥¼ í•œ ë²ˆì— ì €ì¥ (ğŸ‘ğŸ‘ í‰ê°€)

**ìš”ì²­:**
```json
{
  "answer_id": "a_def456",
  "query_id": "q_abc123",
  "feedback": [
    {
      "chunk_id": "c_001",
      "feedback": "positive"
    },
    {
      "chunk_id": "c_002",
      "feedback": "negative"
    }
  ],
  "meta": {
    "user_id": "user123",
    "session_id": "session_001"
  }
}
```

**ì‘ë‹µ:**
```
204 No Content (ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ)
```

**ë‚´ë¶€ ë™ì‘:**
- í”¼ë“œë°± ì €ì¥ (ë©”ëª¨ë¦¬)
- Triplet ë¡œê·¸ ìƒì„± (score â‰¥ 3 â†’ Positive, < 3 â†’ Negative)
- íŒŒì¼ ì €ì¥: `00_data/output/training_data/triplets_group_bgem3.jsonl`

---

### 4ë‹¨ê³„: GET /answers/{answer_id}/chunks/{chunk_id} - ì²­í¬ ìƒì„¸ ì¡°íšŒ

**ì„¤ëª…:** íŠ¹ì • ì²­í¬ì˜ ì „ì²´ í…ìŠ¤íŠ¸ ì¡°íšŒ ([ìì„¸íˆ] ë²„íŠ¼ í´ë¦­ ì‹œ)

**ìš”ì²­:**
```
GET /answers/a_def456/chunks/c_001
```

**ì‘ë‹µ:**
```json
{
  "answer_id": "a_def456",
  "query_id": "q_abc123",
  "chunk_id": "c_001",
  "chunk_text": "ì‹í’ˆìœ„ìƒë²• ì œ48ì¡°(ìœ„ìƒê´€ë¦¬) â‘  ì‹í’ˆì„ ì œì¡°Â·ê°€ê³µÂ·ì¡°ë¦¬Â·ì €ì¥Â·ì†Œë¶„Â·ìš´ë°˜ ë˜ëŠ” íŒë§¤í•˜ëŠ” ìëŠ”..."
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ìë™ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (ê¶Œì¥)

**ì„œë²„ ì‹¤í–‰ í›„ ë³„ë„ í„°ë¯¸ë„ì—ì„œ:**
```bash
cd 03_api
python test_api.py
```

**ì¶œë ¥ ì˜ˆì‹œ:**
```
================================================================================
ğŸ¥ ì„œë²„ í—¬ìŠ¤ ì²´í¬
================================================================================
âœ… ì„œë²„ ì •ìƒ ì‘ë™

================================================================================
1ï¸âƒ£  POST /queries - ì§ˆë¬¸ â†’ ì¹´í…Œê³ ë¦¬ ì¶”ì²œ
================================================================================
ğŸ“¤ Request: { "question": "...", "scope": "all" }
ğŸ“¥ Response: { "query_id": "...", "category_candidates": [...] }
âœ… 1ë‹¨ê³„ ì™„ë£Œ!

================================================================================
2ï¸âƒ£  POST /answers - ë‹µë³€ ìƒì„±
================================================================================
...
âœ… ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!
```

---

### 2. Swagger UI í…ŒìŠ¤íŠ¸ (ì¶”ì²œ)

1. ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:8000/docs ì ‘ì†
2. ê° APIë¥¼ ìˆœì„œëŒ€ë¡œ í…ŒìŠ¤íŠ¸:
   - `POST /queries` â†’ query_id ë³µì‚¬
   - `POST /answers` â†’ category_id ì…ë ¥ â†’ answer_id, chunk_id ë³µì‚¬
   - `POST /feedback/chunks` â†’ feedback ë°°ì—´ ì…ë ¥
   - `GET /answers/{answer_id}/chunks/{chunk_id}` â†’ ì „ì²´ í…ìŠ¤íŠ¸ í™•ì¸
3. "Try it out" ë²„íŠ¼ìœ¼ë¡œ ì§ì ‘ ì‹¤í–‰

---

### 3. curl í…ŒìŠ¤íŠ¸

```bash
# 1ë‹¨ê³„: ì§ˆë¬¸ â†’ ì¹´í…Œê³ ë¦¬ ì¶”ì²œ
curl -X POST http://localhost:8000/queries \
  -H "Content-Type: application/json" \
  -d '{"question": "HACCP ì¸ì¦ ì ˆì°¨ëŠ”?", "scope": "all"}'

# 2ë‹¨ê³„: ë‹µë³€ ìƒì„± (query_id, category_id í•„ìš”)
curl -X POST http://localhost:8000/answers \
  -H "Content-Type: application/json" \
  -d '{
    "query_id": "ë°›ì€_query_id",
    "selected_categories": ["LAW_ì‹í’ˆìœ„ìƒë²•"]
  }'

# 3ë‹¨ê³„: í”¼ë“œë°± ì €ì¥ (answer_id, query_id, chunk_id í•„ìš”)
curl -X POST http://localhost:8000/feedback/chunks \
  -H "Content-Type: application/json" \
  -d '{
    "answer_id": "ë°›ì€_answer_id",
    "query_id": "ë°›ì€_query_id",
    "feedback": [
      {"chunk_id": "ë°›ì€_chunk_id", "feedback": "positive"}
    ]
  }'

# 4ë‹¨ê³„: ì²­í¬ ìƒì„¸ ì¡°íšŒ
curl http://localhost:8000/answers/ë°›ì€_answer_id/chunks/ë°›ì€_chunk_id
```

---

## âœ… êµ¬í˜„ ì™„ë£Œ ì‚¬í•­

### ğŸ“Œ 4ë‹¨ê³„ API
- âœ… 1ë‹¨ê³„: POST /queries - ì§ˆë¬¸ â†’ ì¹´í…Œê³ ë¦¬ ì¶”ì²œ
- âœ… 2ë‹¨ê³„: POST /answers - ë‹µë³€ ìƒì„± (ë™ê¸°)
- âœ… 3ë‹¨ê³„: POST /feedback/chunks - ì²­í¬ í‰ê°€ (204 No Content)
- âœ… 4ë‹¨ê³„: GET /answers/{id}/chunks/{id} - ì²­í¬ ìƒì„¸ ì¡°íšŒ

### ğŸ“¦ ID ê´€ë¦¬
- âœ… `query_id` ìë™ ìƒì„± (uuid4)
- âœ… `answer_id` ìë™ ìƒì„± (uuid4)
- âœ… `chunk_id` ìë™ ìƒì„± (c_xxxxxxxx)
- âœ… `category_id` í¬ë§·: `LAW_ì œëª©` ë˜ëŠ” `MANUAL_ì œëª©`

### ğŸ”‘ í•µì‹¬ ê¸°ëŠ¥
- âœ… **Boot Once íŒ¨í„´** - LLM/ì¸ë±ìŠ¤ 1íšŒ ë¡œë”© (ì•½ 10ì´ˆ ì†Œìš”)
- âœ… **ì „ì²´ ì¹´í…Œê³ ë¦¬** - scope ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„± (LAW_ì „ì²´, MANUAL_ì „ì²´, ALL_ì „ì²´)
- âœ… **ë§¤ë‰´ì–¼ ë²ˆí˜¸ ì œê±°** - "01.ì‹í’ˆì•ˆì „" â†’ "ì‹í’ˆì•ˆì „" (labelë§Œ)
- âœ… **ë§ˆí¬ë‹¤ìš´ ì œê±°** - LLM ë‹µë³€ì—ì„œ `**`, `##`, `-`, "ìš”ì•½:" ë“± ì œê±°
- âœ… **ì²­í¬ ì „ì²´ í…ìŠ¤íŠ¸** - 4ë‹¨ê³„ì—ì„œ ì „ì²´ ì¡°ë¬¸ ì œê³µ
- âœ… **Triplet ìë™ ë¡œê¹…** - í”¼ë“œë°± score â‰¥ 3 (Positive), < 3 (Negative)
- âœ… **ì‹¤ì œ ì‹œê°„ ì¸¡ì •** - `retrieval_ms`, `generation_ms` (ì‹¤ì¸¡)
- âœ… **ë²•ë¥  ë©´ì±…ì‚¬í•­** - scope="law" ë˜ëŠ” "all"ì¼ ë•Œ ìë™ ì¶”ê°€

---

## ğŸ¯ ì£¼ìš” ê¸°ëŠ¥ ìƒì„¸

### 1. Boot Once ì•„í‚¤í…ì²˜
- ì•± ì‹œì‘ ì‹œ LLM/ì„ë² ë”© ëª¨ë¸/FAISS ì¸ë±ìŠ¤ë¥¼ **1íšŒë§Œ ë¡œë”©** (ì•½ 10ì´ˆ)
- ì´í›„ ëª¨ë“  ìš”ì²­ì€ ë¡œë”© ì—†ì´ ì¦‰ì‹œ ì²˜ë¦¬ (2~5ì´ˆ)
- `RAGAdapter` ì‹±ê¸€í†¤ íŒ¨í„´ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©

---

### 2. Citations ê°„ì†Œí™”
```json
{
  "chunk_id": "c_a1b2c3d4",
  "doc_title": "ì‹í’ˆìœ„ìƒë²• ì œ48ì¡° (ìœ„ìƒê´€ë¦¬)",
  "score": 0.87
}
```

**API Responseì—ëŠ” ì œëª©ë§Œ, ë‚´ë¶€ ì €ì¥ì—ëŠ” text í¬í•¨**
- 2ë‹¨ê³„ Response: `chunk_id`, `doc_title`, `score`ë§Œ ë°˜í™˜
- ë‚´ë¶€ ì €ì¥: `text` í¬í•¨ (4ë‹¨ê³„ ì¡°íšŒìš©)
- 4ë‹¨ê³„ì—ì„œ `chunk_text` ì „ì²´ ì œê³µ

---

### 3. ì‹¤ì œ ì‹œê°„ ì¸¡ì •
```json
{
  "timings": {
    "retrieval_ms": 342,    // ì‹¤ì œ ê²€ìƒ‰ ì‹œê°„ (time.time() ì¸¡ì •)
    "generation_ms": 1589   // ì‹¤ì œ LLM ìƒì„± ì‹œê°„
  }
}
```

---

### 4. Triplet ìë™ ë¡œê¹…
**í”¼ë“œë°± ì €ì¥ ì‹œ í•™ìŠµ ë°ì´í„° ìë™ ìƒì„±:**
- ì ìˆ˜ 3 ì´ìƒ â†’ `positives`
- ì ìˆ˜ 2 ì´í•˜ â†’ `negatives`
- ì €ì¥ ê²½ë¡œ: `00_data/output/training_data/triplets_group_bgem3.jsonl`

```jsonl
{"query": "HACCP ì¸ì¦ ì ˆì°¨ëŠ”?", "positives": ["ì‹í’ˆìœ„ìƒë²• ì œ48ì¡°..."], "negatives": [], "meta": {...}}
```

### ì¹´í…Œê³ ë¦¬ ë§¤ì¹­
**ë¬¸ì œ:** ì¶”ì²œ ì‹œ ë²ˆí˜¸ ì œê±° â†’ ê²€ìƒ‰ ì‹œ ì›ë³¸ í‚¤ í•„ìš”
```
ì¶”ì²œ: "ì‹í’ˆì•ˆì „ê´€ë¦¬ì¸ì¦ê¸°ì¤€"
ì¸ë±ìŠ¤ í‚¤: "01.ì‹í’ˆì•ˆì „ê´€ë¦¬ì¸ì¦ê¸°ì¤€"
```

**í•´ê²°:** ë²ˆí˜¸ ì œê±°ëœ ì´ë¦„ìœ¼ë¡œ ì¸ë±ìŠ¤ í‚¤ ì°¾ê¸° (ì •ê·œì‹ ë§¤ì¹­)

---

## ğŸ”„ ì›¹ì‚¬ì´íŠ¸ ì—°ë™ í”Œë¡œìš°

```
1. [ë²•ë ¹/ë§¤ë‰´ì–¼] ì„ íƒ + ì§ˆë¬¸ ì…ë ¥
   â†“
2. [ì—°ê´€ìë£Œ ì¶”ì²œ] ë²„íŠ¼ í´ë¦­
   â†’ POST /queries { scope: "law", question: "..." }
   â† category_id í¬í•¨ ì¶”ì²œ ë°›ìŒ
   â†“
3. ì²´í¬ë°•ìŠ¤ë¡œ ì¹´í…Œê³ ë¦¬ ì„ íƒ
   â†“
4. [ê²€ìƒ‰] ë²„íŠ¼ í´ë¦­
   â†’ POST /answers { query_id, selected_categories }
   â† ë‹µë³€ + citations ë°›ìŒ
   â†“
5. ğŸ‘/ğŸ‘ í‰ê°€
   â†’ POST /feedback/chunks { score: 5 }
   â† Triplet ìë™ ë¡œê¹…
```

---

## âš ï¸ í”„ë¡œë•ì…˜ ë°°í¬ ì „ í™•ì¸ì‚¬í•­

1. **Storage êµì²´**: ë©”ëª¨ë¦¬ ê¸°ë°˜ â†’ DB(PostgreSQL, MongoDB) ë˜ëŠ” Redis
2. **CORS ì„¤ì •**: `allow_origins=["*"]` â†’ íŠ¹ì • ë„ë©”ì¸ë§Œ í—ˆìš©
3. **ì—ëŸ¬ í•¸ë“¤ë§**: ìƒì„¸ ì—ëŸ¬ ë©”ì‹œì§€ â†’ ì¼ë°˜ ë©”ì‹œì§€ë¡œ ë³€ê²½
4. **ë¡œê¹…**: ì½˜ì†” ì¶œë ¥ â†’ íŒŒì¼/ì„œë²„ ë¡œê¹… ì‹œìŠ¤í…œ
5. **ì„œë²„ ì„¤ì •**: Uvicorn â†’ Gunicorn + Uvicorn workers (ë©€í‹°í”„ë¡œì„¸ìŠ¤)
6. **í™˜ê²½ ë³€ìˆ˜**: í•˜ë“œì½”ë”©ëœ ê²½ë¡œ â†’ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬

---

## ğŸ“¦ ì˜ì¡´ì„±

`requirements.txt` ì°¸ê³ :
- FastAPI 0.109.0
- Uvicorn 0.27.0
- Pydantic 2.5.3
- (ê¸°ì¡´ 02_rag ì˜ì¡´ì„± ê³µìœ )
